# 博客站群开发文档 (Next.js + Strapi)

版本：v1.0  
更新日期：2025-10-17

## 1. 架构总览
- 前端：Next.js（SSR/SSG/ISR），多站实例按域名区分。  
- 后端：Strapi（Headless CMS），统一内容与评论管理。  
- 数据库：开发用 SQLite，生产建议 PostgreSQL/MySQL。  
- 部署：前端静态托管+CDN，后端 Node 服务+数据库。

## 2. 技术栈与版本建议
- Node.js：≥ 18.x  
- 包管理：npm 或 yarn / pnpm  
- 前端依赖：`next`, `react`, `react-dom`（可选：`next-sitemap`, `axios`）  
- 后端依赖：Strapi v4.x（内置 Koa），可选：`helmet`, `cors`, 速率限制插件。

## 3. 本地环境准备
- 安装 Node.js 与包管理器。  
- 安装 Git（管理源代码）。  
- Windows 环境使用 PowerShell 运行初始化命令。

## 4. 仓库结构建议
```
blogs/                      # 工作区根
  ├─ blogs-web/             # Next.js 前端（每个域名可部署一套）
  └─ blogs-cms/             # Strapi 后端（内容与评论统一）
```

## 5. 初始化步骤
- 创建 Strapi：
  - 命令：`npx create-strapi-app@latest blogs-cms --quickstart`  
  - 启动后台后，创建管理员账号登录。
- 创建 Next.js：
  - 命令：`npx create-next-app@latest blogs-web`  
  - 选择 TypeScript 可提升可维护性（可选）。

## 6. Strapi 内容类型与配置
- 内容类型：
  - Site（站点）：`name`(string), `domain`(string), `enabled`(boolean), `theme`(json，可选)  
  - Article（文章）：`title`(string), `slug`(uid by title), `summary`(text), `content`(richtext), `site`(relation: many-to-one), `tags`(many-to-many), `categories`(many-to-many), `publishedAt`(datetime)  
  - Comment（评论）：`content`(text), `authorName`(string), `authorLink`(url), `article`(relation), `sourceSite`(relation 可选), `status`(enum: approved/pending/spam)  
  - Tag/Category：基础 string + 关联。  
- 权限：
  - Public 角色：允许 GET 文章列表与详情；POST 评论需表单校验与速率限制（建议使用 API Token 或验证）。  
- CORS：
  - 在 Strapi 中启用允许来自前端站点域名的跨域请求。  
- 安全与清洗：
  - 评论内容在服务端进行 HTML 清洗（XSS 防护，保留 a 标签白名单，自动加 `rel="nofollow"`）。  
- 主动推送（百度）：
  - 可在 Article 发布 lifecycle hook 中调用百度推送接口（`http://data.zz.baidu.com/urls?site=xxx&token=...`），异步提交新 URL。  
  - 亦可通过定时任务批量重推未收录文章。

## 7. Next.js 页面结构与数据获取
- 页面：
  - `pages/index.tsx`：文章列表（分页、按站点筛选）。  
  - `pages/[slug].tsx`：文章详情（评论展示与提交）。  
  - `pages/sitemap.xml.ts`：动态生成 sitemap。  
  - `pages/robots.txt.ts`：动态生成 robots.txt。  
  - `pages/api/cross-comment.ts`：跨站评论 API。  
- 数据获取策略：
  - 列表与详情使用 SSG + ISR（如 `revalidate: 86400`），热门或时效性强的页面可用 SSR。  
  - `getStaticPaths` 使用 `fallback: 'blocking'`，保证首访问即可有完整内容。  
- SEO：
  - 使用 `<Head>` 设置 `<title>`, `<meta name="description">`, `<link rel="canonical">`。  
  - 可选依赖 `next-sitemap` 自动生成 sitemap（构建时输出）。

## 8. 跨站评论 API 设计
- 环境变量：
  - `CMS_URL`（Strapi 地址）、`CMS_TOKEN`（API Token，可选）、`CURRENT_SITE_ID`（当前站点 ID）。  
- 流程：
  1) 接收目标文章 ID；校验与速率限制（IP + 站点 + 时间窗）。  
  2) 从 CMS 中随机拉取其他站点的文章（`filters[site][id][$ne]=CURRENT_SITE_ID`），取一条作为来源。  
  3) 构造评论：`authorName = source.title`，`authorLink = source.url`，`content = source.summary/首段`（插入 a 标签，`rel="nofollow"`）。  
  4) 向 CMS `POST /comments` 写入评论（状态默认为 `pending` 或直接 `approved` 取决于策略）。  
  5) 返回执行结果；必要时记录日志与埋点。  
- 伪代码示例：
```
// pages/api/cross-comment.ts
export default async function handler(req, res) {
  const { articleId } = req.body;
  // 1) 校验与限流（略）
  // 2) 随机来源文章
  const source = await fetch(`${CMS_URL}/articles?filters[site][id][$ne]=${CURRENT_SITE_ID}&pagination[pageSize]=50`).then(r=>r.json());
  const pick = randomPick(source.data);
  // 3) 构造评论
  const payload = {
    data: {
      article: articleId,
      authorName: pick.title,
      authorLink: makeArticleUrl(pick),
      content: `${pick.summary} <a href="${makeArticleUrl(pick)}" rel="nofollow">阅读全文</a>`
    }
  };
  // 4) 提交
  await fetch(`${CMS_URL}/comments`, {
    method: 'POST', headers: authHeaders(), body: JSON.stringify(payload)
  });
  return res.status(200).json({ ok: true });
}
```

## 9. 性能优化清单
- 构建时生成静态页 + ISR，降低 TTFB 与提升可缓存性。  
- 使用 `next/image` 和合适的图片格式（WebP/AVIF），启用懒加载。  
- 关键资源预加载与 `preconnect`（如 CMS 与 CDN）。  
- 代码分割与仅在必要页面加载组件/库。  
- CDN 缓存与合理的 `Cache-Control`。  
- 监控 Core Web Vitals（LCP/CLS/INP）。

## 10. 安全与合规
- 输入校验：对评论与表单做长度、字符、URL 校验。  
- XSS 防护：后端 HTML 清洗；前端避免 `dangerouslySetInnerHTML`。  
- 速率限制：基于 IP/站点/路由的限流；加入简单人机校验（含时间戳校验）。  
- CORS 与认证：限制来源域名；内部管理 API 使用 Token 或角色权限。  
- 版权与采集：来源白名单与标注，避免侵权。

## 11. 部署与发布
- 前端：
  - 构建：`npm run build && npm run export`（如采用静态导出）或部署到支持 Next.js 的平台。  
  - 绑定域名与 CDN（可选使用免费层）。  
- 后端：
  - Node 服务 + 反向代理（Nginx），开启 HTTPS。  
  - 数据库独立实例（PostgreSQL/MySQL）。  
  - 环境变量配置 `CMS_URL`, `CMS_TOKEN`, `CURRENT_SITE_ID` 等。  
- 多站：为每个域名部署一套前端实例（或通过环境变量切换站点过滤），后端统一。

## 12. 运营与任务
- 百度主动推送：构建或发布后批量推送新增 URL。  
- 跨站评论：定时任务触发或手动触发 API；观察评论质量与收录表现。  
- 日志与监控：收集错误日志、接口延时，观察性能与 SEO 指标。

## 13. 测试与质量保障
- 单元测试：对数据处理与 API 调用封装进行测试（Jest）。  
- 端到端测试：页面渲染与交互（Playwright）。  
- SEO 检查：静态 HTML 验证、`sitemap.xml`/`robots.txt` 检查、链接可抓取性。

## 14. 多站策略与扩展
- 前端通过 `CURRENT_SITE_ID` 环境变量过滤站点数据；样式与主题通过 `Site.theme` 控制。  
- 可扩展：引入多语言、AB 测试、广告模块、推荐系统。  
- 数据分层：未来可拆分评论服务或采用消息队列缓冲跨站任务。

## 15. 里程碑与验收
- M0：初始化仓库与基础架构（Strapi + Next）  
- M1：文章列表与详情页（SSG/ISR + SEO 基础）  
- M2：评论系统（提交、展示、审核）  
- M3：sitemap/robots 与百度主动推送  
- M4：跨站评论 API 与任务机制  
- M5：性能优化与上线部署（多域名）

---
按本开发文档执行，可在 2–4 周内完成核心功能并具备上线能力，后续根据数据与 SEO 表现迭代策略与功能。