# 博客站群技术文档（Next.js + Strapi）

版本：v1.0  
更新日期：2025-10-19

## 概览
- 技术栈：
  - 前端：Next.js（App Router）+ React + Tailwind CSS
  - 后端：Strapi v5（SQLite/Postgres，可切换）、Node.js
- 仓库结构：
  - `g:\code\blogs\blogs-web`：前端站群（Next.js）
  - `g:\code\blogs\blogs-cms`：CMS（Strapi）
  - 文档：`g:\code\blogs\需求文档.md`、`g:\code\blogs\开发文档.md`（本文件：`g:\code\blogs\技术文档.md`）

## CMS 架构（Strapi）
- 内容模型（实体）：
  - `api::site.site`：站点（域名、启用状态）
  - `api::category.category`：分类（`name`、`slug`）
  - `api::tag.tag`：标签（`name`、`slug`）
  - `api::article.article`：文章（`title`、`slug`、`summary`、`content`、`site`、`category`、`tags`、`publishedAt`）
  - `api::comment.comment`：评论（`authorName`、`authorLink`、`content`、`status`）
- 启动与数据初始化：
  - 入口：`blogs-cms/src/index.ts` 在 `bootstrap` 时：
    - 自动设置 Public 角色读取文章/分类/标签/站点，允许创建评论。
    - 自动创建默认站点（`localhost:3000`）、基础分类/标签，并种子示例文章与评论。
    - 额外创建演示站点与更多文章（含跨站文章分布）。
- 评论生命周期：
  - `blogs-cms/src/api/comment/content-types/comment/lifecycles.ts`
    - `beforeCreate`：
      - 清洗评论 HTML（`sanitize-html`），裁剪作者名。
      - 校验 `authorLink` 有效性。
      - 初始状态设为 `pending`（待审核）。
- 内部服务与路由：
  - 服务：`blogs-cms/src/api/internal/services/internal.ts`
    - `autoTag`：扫描文章内容，根据关键词映射与分数阈值，关联匹配标签；支持 dryRun、按站点过滤、最小分数、外部映射文件。
    - `aiGenerate`：根据主题/分类/标签生成并入库文章，支持站点关联与发布。
  - 路由：`blogs-cms/src/api/internal/routes/internal.ts`
    - `POST /internal/auto-tag` 与 `POST /internal/ai-generate`（配置为 `auth: false`）。
  - 控制器：`blogs-cms/src/api/internal/controllers/internal.ts`
    - `autoTag`：通过 `x-admin-token` 简单校验；参数支持 query/body 混合输入。
    - `aiGenerate`：解析生成参数、站点绑定与发布。
- CLI 脚本：
  - `blogs-cms/scripts/auto-tag.js`：命令行调用 `autoTag`，支持 `--site`、`--dry`、`--minScore`、`--limit`、`--map`
- 依赖与运行：
  - `blogs-cms/package.json`：`strapi dev|build|start`，`tag:auto`（自动打标签）、`gen:ai`（示例 AI 生成）

## Web 架构（Next.js）
- 数据访问与缓存：
  - 核心：`blogs-web/src/lib/cms.ts`
    - `CMS_URL`、`CMS_TOKEN`、`CURRENT_SITE_ID` 环境变量（通过 `process.env`）。
    - `cmsFetch`：统一 fetch（携带 token，headers、`next: { revalidate: 3600 }`），并带性能 headers。
    - `withCache`：简单包装缓存。
    - `fetchArticles` / `fetchArticleBySlug` / `fetchRelatedArticles`：带站点过滤、分页、排序、字段规整与关系映射。
  - 站内链接：`blogs-web/src/lib/internal-links.ts`：根据文章标题/标签为 HTML 内容自动加内链（排除当前文章）。
- 页面与路由：
  - 首页：`blogs-web/src/app/page.tsx`（列表 + 搜索 + 分页 + 主题化 UI），使用 `fetchArticlesFiltered`（透传至 CMS）
  - 文章详情：`blogs-web/src/app/[slug]/page.tsx`（`revalidate = 0`，当前为 SSR）
  - 标签页：`blogs-web/src/app/t/[slug]/page.tsx`（生成元数据：title、description、canonical）
  - 站点管理（演示）：`blogs-web/src/app/admin/sites/page.tsx`，配合 `src/lib/template.ts` 模板配置体系
  - API 路由：
    - `src/app/api/articles/route.ts`、`src/app/api/categories/route.ts`、`src/app/api/tags/route.ts`
    - `src/app/api/cross-comment/route.ts`：跨站评论 API，按 IP 频率限制
    - `src/app/api/site-config/route.ts`：站点基础配置
- 组件与样式：
  - `SafeHtmlRenderer`（在文章页使用）与 `CommentForm`（评论表单）
  - `Pagination.tsx`（客户端路由分页）
  - Tailwind 配置：`blogs-web/tailwind.config.ts`，Typography 插件与主题扩展
- 配置与 SEO：
  - `blogs-web/next.config.ts`：
    - 开启 Turbo（实验）
    - 图片优化（domains、sizes、formats）
    - 安全头：`X-Content-Type-Options`、`X-Frame-Options`、`X-XSS-Protection`（建议见优化）
    - 资源前缀 `assetPrefix` 以便接入 CDN
    - Webpack splitChunks、可集成 Bundle Analyzer
    - 重定向与重写（将 query 形态 URL 规范化为路径形态）

## 环境与运行
- 环境变量（前端）：
  - 在 `blogs-web/.env.local` 设置：
    - `CMS_URL=https://your-strapi-host`
    - `CMS_TOKEN=<strapi_api_token>`
    - `CURRENT_SITE_ID=<site_id>`
- 启动与开发：
  - CMS：
    - `cd g:\code\blogs\blogs-cms`
    - 开发：`npm run dev`
    - 生产：`npm run build && npm run start`
  - Web：
    - `cd g:\code\blogs\blogs-web`
    - 开发：`npm run dev`（`--turbopack`）
    - 构建：`npm run build`
    - 生产：`npm run start`
- 数据源：默认 SQLite（`better-sqlite3`）；生产建议 Postgres（`pg`）。

## 跨站评论设计（当前实现）
- 来源策略：随机从其他站点选文章，取标题为 `authorName`、链接为 `authorLink`，摘要/首段为评论内容。
- 频率限制：`src/app/api/cross-comment/route.ts` 基于 IP 做速率限制。
- 审核与黑白名单：需求文档已描述（实现上待完善，见优化建议）。

## 现状评估与优化建议

### CMS 优化建议
- 保护内部接口：
  - `POST /internal/auto-tag` 与 `POST /internal/ai-generate` 当前 `auth: false`；建议：
    - 强制校验 `x-admin-token`（已在控制器中使用），同时将路由置于内网或反向代理白名单。
    - 改为使用 Strapi Admin JWT 或服务端环境变量密钥，避免硬编码 header。
- 标签自动化：
  - 将关键词映射文件标准化（JSON/YAML），支持权重、多语言与同义词；
  - 引入得分公式（标题匹配权重 > 正文 > 标签），并记录匹配审计日志（方便回溯）。
- 评论反垃圾与审核：
  - 完善黑白名单（站点、文章、关键词）与审核开关；
  - 生命周期增加来源校验与内容长度/URL 规则；
  - 为 `authorLink` 做域名白名单与 UTM 参数剥离；
  - 增加速率限制（按文章、按站点、按来源）。
- 安全与索引：
  - 为常用字段添加数据库索引（`article.slug`、`tag.slug`、`site.domain`）；
  - 内容清洗白名单策略（仅允许必要标签与属性）；
  - 统一时区与 `publishedAt` 处理，避免排序异常。
- 任务编排：
  - `node-cron` 定时任务：自动打标签、AI 生成、百度推送；
  - 将任务结果写入日志表（`internal:task_runs`）。

### Web 优化建议
- 渲染策略：
  - 文章详情页 `revalidate = 0` 导致每次 SSR；建议：
    - 使用 ISR（如 `revalidate: 300`~`1800`）平衡新鲜度与性能；
    - 热点页或最新评论页面保留 SSR。
- 首页与分页：
  - `Pagination.tsx` 为客户端路由；若 SEO 优先，建议使用 `<Link>` 生成服务端分页，减少客户端路由依赖。
- 缓存与错误处理：
  - `cmsFetch` 可引入超时/重试与降级（返回兜底列表/文案）；
  - 针对 4xx/5xx 分类处理，页面显示缓存或兜底内容。
- SEO：
  - 增加结构化数据（Article JSON-LD）与 Open Graph；
  - 生成 `sitemap.xml`、`robots.txt`、提交链接给百度（主动推送 API）；
  - 为标签/分类页生成 canonical 与描述；
  - 内链工具 `internal-links.ts` 增加停用词与权重，避免过度链出。
- 安全响应头：
  - 现有 `X-XSS-Protection` 已废弃；建议增加：
    - `Content-Security-Policy`（`script-src 'self' https:`，`img-src 'self' data: https:` 等）
    - `Referrer-Policy: strict-origin-when-cross-origin`
    - `Permissions-Policy`（禁用不必要能力，如 `camera=(), microphone=()`）
    - `Strict-Transport-Security`（在 HTTPS 下）
- 资源与样式：
  - 首页 Hero 较重，建议按需裁剪与延迟动画；
  - 图片统一懒加载与占位；CDN 配合 `assetPrefix`。
- 代码正确性：
  - `app/page.tsx` 的 `searchParams` 类型目前为 `Promise<any>` 并 `await`，与 Next 约定不符；建议改为形如 `{ searchParams }: { searchParams?: Record<string, string | string[] | undefined> }`（无需 `await`）。

### DevOps / 部署与安全建议
- 部署拓扑：
  - Strapi：Docker（Postgres + Node），建议部署在独立主机/容器平台（如 Render、Railway 或自托管）；
  - Next.js：建议 Vercel/自托管 Node + CDN。
- 配置与密钥：
  - 使用 `.env` 管理，生产环境配置通过 Secret Manager/平台变量；
  - 禁用在前端暴露敏感信息；`CMS_TOKEN` 仅用于服务端请求。
- 监控与日志：
  - 接入请求日志（Nginx/平台日志）、错误日志与性能指标（TTFB/LCP）；
  - 简单报表（PV/UV）与任务运行仪表盘。
- 安全：
  - 开启 CORS 白名单；
  - WAF/防注入，输入校验与统一清洗；
  - 速率限制（IP + 用户维度），上传/评论做额外限制。

## 运行与测试建议
- 单元测试：为 `cms.ts` 的数据转换与 `internal-links.ts` 内链逻辑增加基础测试。
- 端到端：对文章详情 SSR/ISR、分页与评论提交的路径做 E2E 测试。

## 后续路线
- 多语言与站点主题个性化配置；
- 搜索功能（简单词法检索或接入搜索服务）；
- 运营工具：批量改写、批量标签管理、批量推送。